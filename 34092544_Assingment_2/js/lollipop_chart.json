{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "title": "Agriculture Imports vs Exports â€” Malaysia (2010â€“2021)",
  "width": "container",
  "height": 360,
  "data": { "url": "data/import_export.csv", "format": { "type": "csv" } },
  "params": [
    {
      "name": "yearGroup",
      "value": "Even Years",
      "bind": {
        "input": "select",
        "options": ["Even Years", "Odd Years"],
        "name": "Year Group: "
      }
    }
  ],
  "transform": [
    { "calculate": "toNumber(datum.Year)", "as": "YearNum" },
    { "filter": "isValid(datum.YearNum) && datum.YearNum >= 2010 && datum.YearNum <= 2021" },
    { "calculate": "lower(datum['Indicator Name'] + '')", "as": "label" },
    {
      "calculate": "test(/import/, datum.label) ? 'Import' : (test(/export/, datum.label) ? 'Export' : 'Other')",
      "as": "Type"
    },
    { "calculate": "isValid(datum['Value(%)']) ? toNumber(datum['Value(%)']) : toNumber(datum.Value)", "as": "Val" },
    { "filter": "isValid(datum.Val)" },
    {
      "filter": "yearGroup == 'Even Years' ? (datum.YearNum == 2010 || datum.YearNum == 2012 || datum.YearNum == 2014 || datum.YearNum == 2016 || datum.YearNum == 2018 || datum.YearNum == 2020) : (datum.YearNum == 2011 || datum.YearNum == 2013 || datum.YearNum == 2015 || datum.YearNum == 2017 || datum.YearNum == 2019 || datum.YearNum == 2021)"
    },
    { "calculate": "0", "as": "Zero" },
    { "calculate": "datum.Type == 'Export' ? -12 : 12", "as": "xoff" },
    { "calculate": "format(datum.Val, '.2f') + '%'", "as": "ValWithPercent" }
  ],
  "encoding": {
    "x": { "field": "YearNum", "type": "ordinal", "title": "Year", "sort": "ascending" },
    "color": {
      "field": "Type",
      "type": "nominal",
      "title": null,
      "scale": { "domain": ["Export", "Import"], "range": ["#4e79a7", "#e15759"] }
    }
  },
  "layer": [
    {
      "mark": { "type": "rule", "strokeWidth": 3, "opacity": 0.35 },
      "encoding": {
        "xOffset": { "field": "xoff" },
        "y": { "field": "Zero", "type": "quantitative", "axis": { "title": "Value (%)" }, "scale": { "domainMin": 0 } },
        "y2": { "field": "Val" }
      }
    },
    {
      "mark": { "type": "circle", "filled": true, "size": 1500, "stroke": null },
      "encoding": {
        "xOffset": { "field": "xoff" },
        "y": { "field": "Val", "type": "quantitative" },
        "tooltip": [
          { "field": "YearNum", "title": "Year" },
          { "field": "Type", "title": "Type" },
          { "field": "ValWithPercent", "title": "Value", "type": "nominal" }
        ]
      }
    },
    {
      "mark": {
        "type": "text",
        "align": "center",
        "dy": -10,
        "fontSize": 12,
        "fontWeight": "bold",
        "fill": "black"
      },
      "encoding": {
        "xOffset": { "field": "xoff" },
        "y": { "field": "Val", "type": "quantitative" },
        "text": { "field": "Val", "type": "quantitative", "format": ".2f" }
      }
    },
    {
      "transform": [
        { "filter": "datum.Type == 'Export'" },
        {
          "aggregate": [
            { "op": "argmax", "field": "Val", "as": "row_max" },
            { "op": "argmin", "field": "Val", "as": "row_min" }
          ]
        },
        { "calculate": "'Export Statistics:'", "as": "line1" },
        {
          "calculate": "'Highest: Year ' + toString(datum.row_max.YearNum) + ' (' + format(datum.row_max.Val, '.2f') + '%)'",
          "as": "line2"
        },
        {
          "calculate": "'Lowest: Year ' + toString(datum.row_min.YearNum) + ' (' + format(datum.row_min.Val, '.2f') + '%)'",
          "as": "line3"
        }
      ],
      "layer": [
        {
          "mark": { "type": "text", "fontSize": 13, "fontWeight": "bold", "align": "left" },
          "encoding": {
            "x": { "value": 290 },
            "y": { "value": 10 },
            "text": { "field": "line1" },
            "color": { "value": "#4e79a7" }
          }
        },
        {
          "mark": { "type": "text", "fontSize": 12, "align": "left" },
          "encoding": {
            "x": { "value": 290 },
            "y": { "value": 30 },
            "text": { "field": "line2" },
            "color": { "value": "black" }
          }
        },
        {
          "mark": { "type": "text", "fontSize": 12, "align": "left" },
          "encoding": {
            "x": { "value": 290 },
            "y": { "value": 50 },
            "text": { "field": "line3" },
            "color": { "value": "black" }
          }
        }
      ]
    },
    {
      "transform": [
        { "filter": "datum.Type == 'Import'" },
        {
          "aggregate": [
            { "op": "argmax", "field": "Val", "as": "row_max" },
            { "op": "argmin", "field": "Val", "as": "row_min" }
          ]
        },
        { "calculate": "'Import Statistics:'", "as": "line1" },
        {
          "calculate": "'Highest: Year ' + toString(datum.row_max.YearNum) + ' (' + format(datum.row_max.Val, '.2f') + '%)'",
          "as": "line2"
        },
        {
          "calculate": "'Lowest: Year ' + toString(datum.row_min.YearNum) + ' (' + format(datum.row_min.Val, '.2f') + '%)'",
          "as": "line3"
        }
      ],
      "layer": [
        {
          "mark": { "type": "text", "fontSize": 13, "fontWeight": "bold", "align": "left" },
          "encoding": {
            "x": { "value": 450 },
            "y": { "value": 10 },
            "text": { "field": "line1" },
            "color": { "value": "#e15759" }
          }
        },
        {
          "mark": { "type": "text", "fontSize": 12, "align": "left" },
          "encoding": {
            "x": { "value": 450 },
            "y": { "value": 30 },
            "text": { "field": "line2" },
            "color": { "value": "black" }
          }
        },
        {
          "mark": { "type": "text", "fontSize": 12, "align": "left" },
          "encoding": {
            "x": { "value": 450 },
            "y": { "value": 50 },
            "text": { "field": "line3" },
            "color": { "value": "black" }
          }
        }
      ]
    }
  ]
}
