{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "title": "How Fertilizer Changes Relate to ↑Yield (2017–2021)",
  "data": { "url": "data/year_yield.csv" },

  "transform": [
    { "filter": "datum.Year >= 2017 && datum.Year <= 2021" },

   
    {
      "calculate": "isValid(datum.yield) ? datum.yield : (datum.planted_area>0 ? datum.production/datum.planted_area : null)",
      "as": "yield_val"
    },

    
    {
      "window": [{ "op": "lag", "field": "yield_val", "as": "prev_yield" }],
      "groupby": ["state"],
      "sort": [{ "field": "Year", "order": "ascending" }]
    },
    { "calculate": "datum.yield_val - datum.prev_yield", "as": "dy" },

   
    {
      "lookup": "Year",
      "from": { "data": { "url": "data/Fertilizer_Consumption.csv" }, "key": "Year", "fields": ["Value"] },
      "as": ["fert_val"]
    },
    { "calculate": "datum.Year - 1", "as": "PrevYear" },
    {
      "lookup": "PrevYear",
      "from": { "data": { "url": "data/Fertilizer_Consumption.csv" }, "key": "Year", "fields": ["Value"] },
      "as": ["fert_prev"]
    },
    {
      "calculate": "isValid(datum.fert_prev) && isValid(datum.fert_val) ? datum.fert_val - datum.fert_prev : null",
      "as": "dfert"
    },


    { "filter": "isValid(datum.dy) && isValid(datum.dfert)" },
    { "calculate": "datum.dfert > 0 ? 'With ↑Fertilizer' : 'Without ↑Fertilizer'", "as": "group" },
    { "calculate": "datum.dy > 0", "as": "yield_up" },

    {
      "aggregate": [
        { "op": "count", "as": "n_states" },
        { "op": "sum", "field": "yield_up", "as": "n_yield_up" }
      ],
      "groupby": ["Year", "group"]
    },
    { "calculate": "round(100 * datum.n_yield_up / datum.n_states)", "as": "pct" },

  
    { "calculate": "sequence(1, 101)", "as": "seq" },
    { "flatten": ["seq"] },
    { "calculate": "datum.seq <= datum.pct ? 'filled' : 'empty'", "as": "cellState" },
    { "calculate": "ceil(datum.seq/10)", "as": "row" },
    { "calculate": "((datum.seq - 1) % 10) + 1", "as": "col" }
  ],

  "facet": {
    "row":   { "field": "group", "title": null },
    "column":{ "field": "Year", "type": "ordinal", "title": "Year" }
  },

  "spec": {
    "width": 120,
    "height": 120,
    "layer": [
    
      {
        "mark": { "type": "rect", "cornerRadius": 2 },
        "encoding": {
          "x": { "field": "col", "type": "ordinal", "axis": null },
          "y": { "field": "row", "type": "ordinal", "axis": null, "sort": "descending" },
          "fill": {
            "field": "cellState",
            "type": "nominal",
            "scale": { "domain": ["filled", "empty"], "range": ["#4e79a7", "#e6e6e6"] },
            "legend": null
          },
          "tooltip": [
            { "field": "Year" },
            { "field": "group", "title": "Group" },
            { "field": "pct", "title": "% states with ↑yield" },
            { "field": "n_yield_up", "title": "States with ↑yield" },
            { "field": "n_states", "title": "States counted" }
          ]
        }
      },

      {
        "transform": [
          {
            "aggregate": [
              { "op": "max", "field": "pct", "as": "pct" },
              { "op": "max", "field": "n_yield_up", "as": "n_yield_up" },
              { "op": "max", "field": "n_states", "as": "n_states" }
            ]
          },
          { "calculate": "toString(datum.pct) + '%'", "as": "pct_label" }
        ],
        "mark": { "type": "text", "fontSize": 16, "fontWeight": "bold", "align": "center", "baseline": "bottom" },
        "encoding": {
          "text": { "field": "pct_label" },
          "x": { "value": 60 },   
          "y": { "value": -6 }    
        }
      }
    ]
  }
}
